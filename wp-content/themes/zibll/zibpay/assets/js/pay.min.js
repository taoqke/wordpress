function pay_action_ajax(a,e){$(".modal:not(#modal_pay)").modal("hide");var i=$("#modal_pay");i.length&&!a.openid&&i.modal("show").find(".pay-payment").removeClass("wechat alipay").addClass(a.pay_type),i.find(".more-html").remove(),pay_ajax_notice("正在生成订单，请稍候","load"),i.length||(notyf("加载中，请稍等...","load","","pay_ajax"),a.get_modal=1),a.openid&&notyf("正在发起支付，请稍等...","load","","pay_ajax"),$.ajax({type:"POST",url:pay_ajax_url,data:a,dataType:"json",error:function(a){var e="操作失败 "+a.status+" "+a.statusText+"，请刷新页面后重试";a.responseText&&a.responseText.indexOf("致命错误")>-1&&(e="网站遇到致命错误，请检查插件冲突或通过错误日志排除错误"),notyf(e,"danger","","pay_ajax")},success:function(e){return(e.msg||!i.length)&&notyf(e.msg||"请扫码付款，付款成功后会自动跳转",e.ys?e.ys:e.error?"danger":"","",i.length?"":"pay_ajax"),i.length||(_body.append(e.pay_modal),auto_fun(),i=$("#modal_pay"),i.modal("show")),e.error?(pay_ajax_notice(e.msg?e.msg:"处理失败,即将刷新页面","danger"),setTimeout(function(){location.href=delQueStr("openid",delQueStr("zippay")),location.reload},2e3)):(order_result=e,is_verify||(verify_pay(),is_verify=!0)),e.jsapiParams?(pay_sapiParams=e.jsapiParams,"undefined"==typeof WeixinJSBridge?document.addEventListener?document.addEventListener("WeixinJSBridgeReady",onBridgeReady,!1):document.attachEvent&&(document.attachEvent("WeixinJSBridgeReady",onBridgeReady),document.attachEvent("onWeixinJSBridgeReady",onBridgeReady)):onBridgeReady(),notyf("请完成支付","","",a.openid?"pay_ajax":""),pay_ajax_notice("请完成支付","")):(e.order_name&&i.find(".pay-title").html(e.order_name),e.order_price&&i.find(".pay-price").html(e.order_price),e.payment_method&&i.find(".pay-payment").removeClass("wechat alipay").addClass(e.payment_method),e.more_html&&!e.open_url&&i.find(".pay-notice").before('<div class="more-html">'+e.more_html+"</div>"),e.url_qrcode&&!e.open_url&&(qrcode_box=i.find(".pay-qrcode img"),qrcode_box.attr("src",e.url_qrcode).css({filter:"blur(0)",opacity:"1",transition:"all 0.3s ease 0.5s"}),pay_ajax_notice("请扫码付款，付款成功后会自动跳转","")),e.url&&e.open_url?(window.location.href=e.url,window.location.reload,void pay_ajax_notice("正在跳转到支付页面","")):void(e.url||e.url_qrcode||pay_ajax_notice(e.msg?e.msg:"支付配置错误","danger")))}})}function onBridgeReady(){pay_sapiParams&&WeixinJSBridge.invoke("getBrandWCPayRequest",pay_sapiParams,function(a){a.err_msg,location.href=delQueStr("openid",delQueStr("zippay")),location.reload})}function pay_ajax_notice(a,e){var i=$("#modal_pay").find(".pay-notice .notice");a="load"==e?'<i class="loading mr6"></i>'+a:a,i.removeClass("load warning success danger").addClass(e).html(a)}function verify_pay(){order_result.order_num&&$.ajax({type:"POST",url:pay_ajax_url,data:{action:"check_pay",post_id:pay_inputs.post_id,order_num:order_result.order_num},dataType:"json",success:function(a){"1"==a.status?(pay_ajax_notice("付款成功，页面跳转中","success"),setTimeout(function(){void 0!==pay_inputs.return_url&&pay_inputs.return_url?(window.location.href=delQueStr("openid",delQueStr("zippay",pay_inputs.return_url)),window.location.reload):(location.href=delQueStr("openid",delQueStr("zippay")),location.reload)},500)):setTimeout(function(){verify_pay()},2e3)}})}function isWeiXinApp(){var a=window.navigator.userAgent.toLowerCase();return"micromessenger"==a.match(/MicroMessenger/i)}function GetRequest(a){var e=window.parent.location.search;if(-1!=e.indexOf("?")){var i=e.substr(1);i.indexOf(!0)&&(i=i.substr(0)),strs=i.split("&");for(var t=0;t<strs.length;t++)if(-1!=strs[t].indexOf(a))return strs[t].split("=")[1]}return null}function delQueStr(a,e){var t="";if(e=e||window.location.href,-1==e.indexOf("?"))return e;t=e.substr(e.indexOf("?")+1);var n="",r="";if(-1!=t.indexOf("&")){for(i in n=t.split("&"),n)n[i].split("=")[0]!=a&&(r=r+n[i].split("=")[0]+"="+n[i].split("=")[1]+"&");return e.substr(0,e.indexOf("?"))+"?"+r.substr(0,r.length-1)}return n=t.split("="),n[0]==a?e.substr(0,e.indexOf("?")):e}var pay_ajax_url=_win.ajax_url,order_result={},pay_inputs={},_body=$("body"),is_verify=!1,pay_sapiParams=!1;$("link#pay_css").length||$("head").append('<link type="text/css" id="pay_css" rel="stylesheet" href="'+_win.uri+'/zibpay/assets/css/main.css">'),_body.on("click",".initiate-pay-switch",function(a){var e=$(this);return pay_inputs.pay_type=e.attr("pay_type"),pay_action_ajax(pay_inputs,e),e.parents(".pay-payment").find(".pay-qrcode img").css({filter:"blur(5px)",opacity:".8",transition:"all 0.3s"}),!1}),_body.on("click",".initiate-pay",function(a){var e=$(this),i=e.parents("form");return pay_inputs=i.serializeObject(),pay_inputs.pay_type=e.attr("pay_type"),pay_inputs.return_url||(pay_inputs.return_url=window.location.href),pay_action_ajax(pay_inputs,e),!1}),_body.on("hide.bs.modal","#modal_pay",function(){order_result.order_num=!1,is_verify=!1}),_body.on("click",".pay-vip",function(a){var e=$(this),i='<div class="modal fade flex jc" id="modal_pay_uservip" tabindex="-1" role="dialog" aria-hidden="false">    <div class="modal-dialog" role="document">    <div class="modal-content">    <div class="modal-body"><h4 style="padding:20px;" class="text-center"><i class="loading zts em2x"></i></h4></div>    </div>    </div>    </div>    </div>';$("#modal_pay_uservip").length||_body.append(i),auto_fun();var t=$("#modal_pay_uservip"),n=e.attr("vip-level")||1;return t.find(".payvip-modal").length?($('a[href="#tab-payvip-'+n+'"]').tab("show"),t.modal("show")):(notyf("加载中，请稍等...","load","","payvip_ajax"),$.ajax({type:"POST",url:pay_ajax_url,data:{action:"pay_vip",vip_level:n},dataType:"json",success:function(a){var e=a.msg||"请选择会员选项";-1!=e.indexOf("登录")&&(t.remove(),$(".signin-loader").click()),notyf(e,a.ys?a.ys:a.error?"danger":"",3,"payvip_ajax"),a.error||(t.find(".modal-content").html(a.html),t.modal("show"))}})),!1}),$(document).ready(function(){var a=GetRequest("zippay"),e=GetRequest("openid");if(a&&e&&isWeiXinApp()){var i={};i.pay_type=a,i.openid=e,i.action="initiate_pay",pay_action_ajax(i)}});