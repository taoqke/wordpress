(function(){function a(a){var t=$(".vote-options");a.length&&t.length&&("pk"==a.val()?(t.children().eq(1).nextAll().remove(),t.data("max",2).cloneable()):t.data("max",10).cloneable())}var t=$("body");t.on("click","[ajax-action]",function(){var a=$(this);if(a.attr("disabled"))return!1;var t=a.attr("data-id"),e=a.attr("ajax-action"),n=a.find("text");n=n.length?n:a.siblings("text");var i=n.html();a.attr("disabled",!0),n.html('<i class="loading-spot"><i></i></i>'),$.ajax({type:"POST",url:_win.ajax_url,dataType:"json",data:{id:t,action:e},error:function(t){var e="操作失败 "+t.status+" "+t.statusText+"，请刷新页面后重试";t.responseText&&t.responseText.indexOf("致命错误")>-1&&(e="网站遇到致命错误，请检查插件冲突或通过错误日志排除错误"),notyf(e,"danger"),a.attr("disabled",!1),n.html(i)},success:function(s){a.attr("disabled",!1),s.data&&s.success?(s=s.data,$('[ajax-action="'+e+'"][data-id="'+t+'"]').each(function(){var a=$(this),t=a.find("text");t=t.length?t:a.siblings("text"),t.html(s.text||i).addClass("ajaxed"),s.active?a.addClass("active").siblings(".active").removeClass("active"):a.removeClass("active")})):(n.html(i),s.data&&s.data.msg&&notyf(s.data.msg,s.data.ys||"danger"))}})}),t.on("click",".bbs-posts-submit",function(){var a=$(this),t=a.attr("action"),e=a.parents("form"),n=e.serializeObject();n.action=t,tinyMCE&&(n.post_content=tinyMCE.activeEditor.getContent()),zib_ajax(a,n,function(a){a.html&&e.find(".submit-text").html(a.html),a.post_id&&e.find('input[name="post_id"]').val(a.post_id)})}),$.fn.cloneable=function(){function a(a,t,i){var s=a.children().length;t&&t<=s?a.nextAll(e).hide():a.nextAll(e).show(),i&&i>=s?a.find(n).hide():a.find(n).show()}var t="cloneable",e="."+t+"-add",n="."+t+"-remove",i="."+t+"-item";return this.each(function(){var t=$(this),s=t.children(),o="is-on",r="click",l=t.data("max")||0,d=t.data("min")||0;if(a(t,l,d),s.length&&!t.attr(o)){var c=$(s[0]).clone(!1);c.find("input").val(""),t.attr(o,!0).on(r,n,function(){$($(this).parents(i)[0]).remove(),a(t,l,d)}).nextAll(e).on(r,function(){t.append(c.clone(!1)),a(t,l,d)})}})},$(".cloneable").cloneable(),t.on("change","[name='vote[type]']",function(t){a($(this))}),a($("[name='vote[type]']")),$.fn.dependency=function(){function a(a){switch(a){case!0:case"true":case 1:case"1":a=!0;break;case null:case!1:case"false":case 0:case"0":a=!1}return a}function t(a){return Number(a)}function e(e,n,i){if("=="==e)return a(n)==a(i);if("!="==e)return a(n)!=a(i);if(">="==e)return t(i)>=t(n);if("<="==e)return t(i)<=t(n);if(">"==e)return t(i)>t(n);if("<"==e)return t(i)<t(n);if("any"==e){if($.isArray(i)){for(var s=i.length-1;s>=0;s--)if(-1!==$.inArray(i[s],n.split(",")))return!0}else if(-1!==$.inArray(i,n.split(",")))return!0}else if("not-any"==e)if($.isArray(i)){for(s=i.length-1;s>=0;s--)if(-1==$.inArray(i[s],n.split(",")))return!0}else if(-1==$.inArray(i,n.split(",")))return!0;return!1}return this.each(function(){var a=$(this),t=a.find("[data-controller]");if(t.length){var n="is-on";t.each(function(){var t=$(this);if(!t.attr(n)){var i=t.attr(n,!0).data("controller").split("|"),s=t.data("condition").split("|"),o=t.data("value").toString().split("|");$.each(i,function(n,i){var r=o[n]||"",l=s[n]||s[0]||"==";a.on("change","[name='"+i+"']",function(a){var n=$(this),i=n.attr("type"),s="checkbox"==i?n.is(":checked"):n.val();e(l,r,s)?t.slideDown(300):t.slideUp(300)})})}})}})},t.on("loaded.bs.modal",".modal",function(){$(".modal .dependency-box").dependency()}),$(".dependency-box").dependency(),$.fn.vote=function(){function a(a,t=0){var e=a.data(i+"-all")+t,n=a.data("type");a.find(m).each(function(a,t){var s=$(this),o=s.data(i);s.children("."+u).length||s.prepend('<div class="'+u+'"></div>');var r=(o/e*100).toFixed(4);"px"!=n||e||(r="50%"),setTimeout(function(){s.children("."+u).css("width",r+"%")},200),s.children("."+f).html(~~r+"%"),s.children("."+h).html(o+"票")})}function t(t,n){n.action=v,t.hasClass(l)||(t.addClass(l),$.post(e,n,function(e){if(e.data){t.off(o).removeClass(l+" "+r).addClass(c),a(t,n.voted.length);var i=t.find("."+d);i.length&&i.text(1+~~i.text()),t.find("."+s).html("投票成功"),t.find(p).hide()}else t.removeClass(l)},"json"))}var e=_win.ajax_url,n="vote",i=n+"d",s=n+"-start",o="click",r=n+"-allow",l=n+"-loading",d=n+"-user-count",c=n+"-ok",u=n+"-progress",f=n+"-percentage",h=n+"-number",v="submit_"+n,m="."+n+"-item",p="."+n+"-submit",g="is-"+i,x="is-on";return this.each(function(){var e=$(this),n=e.data("type"),s=e.data("post-id"),d={id:s};if(a(e),e.hasClass(r)&&!e.data(x))if("multiple"==n){var c=e.find(p);e.data(x,!0).on(o,m,function(){var a=$(this),t=a.data(i);a.hasClass(g)?a.removeClass(g).data(i,t-1):a.addClass(g).data(i,t+1),e.find(m+"."+g).length?c.show():c.hide()}).on(o,p,function(){if(!e.hasClass(l)){var a=[];e.find(m).each(function(t,e){$(this).hasClass(g)&&a.push(t)}),d.voted=a,t(e,d)}})}else e.data(x,!0).on(o,m,function(){if(!e.hasClass(l)){var a=$(this).addClass(g),n=a.data(i);a.data(i,n+1);var s=a.data("index");d.voted=[s],t(e,d)}})})},$.fn.AutoSearch=function(){return this.each(function(){function a(){var a={},n=t.serializeObject();$.each(n,function(t,e){a[t]=e}),t.find("input[name]").each(function(){var t=$(this),e=t.val()||"";a[t.attr("name")]=e}),t.addClass(o),c.html(m),u.html(v),d.css({height:d.outerHeight(),overflow:"hidden"}),$.post(e,a,function(a){a.data&&d.html('<div class="'+l+'">'+a.data+"</div>").animate({height:d.children("."+l).outerHeight()},200,"swing",function(){d.css({height:"",overflow:"",transition:""})}),t.removeClass(o),c.html(a.remind||""),u.html(f)},"json")}var t=$(this),e=t.attr("ajax-url")||_win.ajax_url,n=2,i="search-",s="."+i,o=i+"loading",r=s+"input",l=i+"centent",d=t.find(s+"container"),c=t.find(s+"remind"),u=t.find(s+"icon"),f=u.html(),h="请至少输入"+n+"个字符",v='<i class="loading em12"></i>',m=v+'<span class="ml6">正在搜索，请稍候...</span>',p="is-on";t.data(p)||t.data(p,!0).find(r).on("input",debounce(function(){var t=$(this);t.val().length>=n?a():c.html(h)},200))})},t.on("loaded.bs.modal",".modal",function(){$(".modal .auto-search").AutoSearch()}),$(".auto-search").AutoSearch(),document.addEventListener("lazybeforeunveil",function(a){var t=$(a.target);t.hasClass("vote-box")&&setTimeout(function(){t.vote()},500)}),t.on("miniuploaded","[term-taxonomy]",function(a,t){if(t.term_id){if("add"===t.type)switch(t.taxonomy){case"plate_cat":var e=$(".plate-cat-radio");if(e.length){e.find(".container-null").remove();var n=$('<label><input type="radio" name="cat" value="'+t.term_id+'"><span class="p2-10 mr6 but but-radio">'+t.term.name+"</span></label>");return e.prepend(n),n.click()}break;case"forum_tag":e=$(".posts-tag-select");if(e.length){n=$('<span data-multiple="5" data-for="tag" data-value="'+t.term_id+'" class="tag-list ajax-item pointer"><span class="badg mm3">'+t.term.name+"</span></span>");return e.prepend(n),n.click()}break;case"forum_topic":e=$(".posts-topic-select");if(e.length){n=$('<div data-for="topic" data-value="'+t.term_id+'" class="flex padding-10 topic-list ajax-item pointer"><div class="square-box mr10 thumb">'+(t.image_url?'<img src="'+t.image_url+'" class="fit-cover radius4">':"")+'</div><div class="info"><div class="name"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-topic"></use></svg>'+t.term.name+'<svg class="icon" aria-hidden="true"><use xlink:href="#icon-topic"></use></svg></div><div class="muted-3-color em09 desc"><span class="mr20">帖子:0</span><span class="">2秒前创建</span></div></div></div>');return e.prepend(n),n.click()}}window.location.href=t.term_url,window.location.reload}}),t.on("miniuploaded","[plate-save]",function(a,t){if(t.id){if("add"===t.type){var e=$(".posts-plate-select");if(e.length){var n=$('<div data-for="plate" data-value="'+t.id+'" class="flex padding-10 plate-list ajax-item pointer"><div class="square-box mr10 thumb">'+(t.image_url?'<img src="'+t.image_url+'" class="radius-cover">':"")+'</div><div class="info"><div class="name">'+t.post.post_title+'</div><div class="muted-3-color em09 desc mt3">3秒前发布</div></div></div>');return e.prepend(n),n.click()}}window.location.href=t.url,window.location.reload}})})();